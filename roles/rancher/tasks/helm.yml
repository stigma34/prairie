---
- name: Download Helm installer script
  get_url:
    url: "{{ helm_url }}"
    dest: /opt/get_helm.sh
    mode: '0755'

- name: Install Helm (optionally pinned)
  environment:
    PATH: "/usr/local/bin:{{ ansible_env.PATH | default('/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin') }}"
  command: >-
    /opt/get_helm.sh
    {% if helm_version | default('') | length > 0 %}--version {{ helm_version }}{% endif %}
  register: helm_install
  changed_when: >
    ('installed' in (helm_install.stdout | lower))
    or ('installed into' in (helm_install.stdout | lower))
    or ('downloading' in (helm_install.stdout | lower))

- name: Ensure Rancher Helm repo is configured
  kubernetes.core.helm_repository:
    name: "{{ rancher_helm_repo_name }}"
    repo_url: "{{ rancher_helm_repo_url }}"
    state: present
    force_update: true
  register: rancher_repo_result
  failed_when: false

- name: Ensure Jetstack Helm repo is configured
  kubernetes.core.helm_repository:
    name: "{{ jetstack_helm_repo_name }}"
    repo_url: "{{ jetstack_helm_repo_url }}"
    state: present
    force_update: true
  register: jetstack_repo_result
  failed_when: false

- name: Update Helm repos
  command: helm repo update
  register: helm_repo_update
  changed_when: "'Update Complete.' in helm_repo_update.stdout"
