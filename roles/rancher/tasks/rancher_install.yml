- name: Ensure cattle-system namespace exists
  command: kubectl get namespace {{ rancher_namespace }}
  register: cattle_ns
  failed_when: false
  changed_when: false

- name: Create cattle-system namespace
  command: kubectl create namespace {{ rancher_namespace }}
  when: cattle_ns.rc != 0

- name: Check if Rancher TLS secret exists
  command: kubectl get secret tls-rancher-ingress -n {{ rancher_namespace }}
  register: rancher_tls_secret
  failed_when: false
  changed_when: false
  when: prairie_tls_mode == 'selfsigned'

- name: Create self-signed Rancher TLS secret if missing
  shell: |
    openssl req -x509 -nodes -days 365 \
      -newkey rsa:2048 \
      -keyout /tmp/rancher-tls.key \
      -out /tmp/rancher-tls.crt \
      -subj "/CN={{ rancher_hostname }}/O=Prairie"
    kubectl create secret tls tls-rancher-ingress \
      -n {{ rancher_namespace }} \
      --cert=/tmp/rancher-tls.crt \
      --key=/tmp/rancher-tls.key
  args:
    creates: /tmp/rancher-tls.crt
  when:
    - prairie_tls_mode == 'selfsigned'
    - rancher_tls_secret.rc != 0

- name: Deploy or upgrade Rancher (self-signed secret)
  command: >
    helm upgrade --install rancher {{ rancher_helm_repo_name }}/rancher
    --namespace {{ rancher_namespace }}
    --create-namespace
    --wait --timeout 1200s
    --set hostname={{ rancher_hostname }}
    --set replicas={{ rancher_replicas }}
    --set ingress.tls.source=secret
    --set ingress.tls.secretName=tls-rancher-ingress
    {{ '--version ' ~ rancher_chart_version if rancher_chart_version|length > 0 else '' }}
  register: rancher_helm
  changed_when: >
    'Release "rancher" has been upgraded' in rancher_helm.stdout or
    'Release "rancher" has been installed' in rancher_helm.stdout
  when: prairie_tls_mode == 'selfsigned'

# ... namespace + self-signed bits unchanged ...

# ðŸ”¹ RKE2 + LE: wait for ingress and webhook BEFORE Helm
- name: Wait for RKE2 ingress-nginx controller deployment to be ready
  command: >
    kubectl -n kube-system rollout status deployment/rke2-ingress-nginx-controller
    --timeout=600s
  register: rke2_ingress_rollout
  changed_when: false
  failed_when: rke2_ingress_rollout.rc != 0
  when:
    - prairie_kubernetes_distribution == 'rke2'
    - prairie_tls_mode == 'letsencrypt'

- name: Wait for RKE2 ingress-nginx admission webhook endpoints
  command: >
    kubectl -n kube-system get endpoints rke2-ingress-nginx-controller-admission
    -o jsonpath='{.subsets[0].addresses[0].ip}'
  register: rke2_ingress_ep
  changed_when: false
  retries: 30
  delay: 6
  until:
    - rke2_ingress_ep.rc == 0
    - rke2_ingress_ep.stdout | length > 0
  when:
    - prairie_kubernetes_distribution == 'rke2'
    - prairie_tls_mode == 'letsencrypt'

- name: Deploy or upgrade Rancher (Let's Encrypt)
  command: >
    helm upgrade --install rancher {{ rancher_helm_repo_name }}/rancher
    --namespace {{ rancher_namespace }}
    --create-namespace
    --wait --timeout 1200s
    --set hostname={{ rancher_hostname }}
    --set replicas={{ rancher_replicas }}
    --set ingress.tls.source=letsEncrypt
    --set letsEncrypt.email={{ vault_lets_encrypt_email }}
    --set letsEncrypt.ingress.class={{ rancher_ingress_class }}
    {{ '--version ' ~ rancher_chart_version if rancher_chart_version|length > 0 else '' }}
  register: rancher_helm
  changed_when: >
    'Release "rancher" has been upgraded' in rancher_helm.stdout or
    'Release "rancher" has been installed' in rancher_helm.stdout
  when: prairie_tls_mode == 'letsencrypt'
