---
- name: Apply cert-manager CRDs
  command: kubectl apply -f "{{ cert_manager_url }}"
  register: certmgr_apply
  changed_when: >
    'configured' in certmgr_apply.stdout or
    'created' in certmgr_apply.stdout

- name: Wait for cert-manager CRDs to be Established
  command: >
    kubectl wait --for=condition=Established --timeout=240s crd -l app.kubernetes.io/name=cert-manager
  register: certmgr_crd_wait
  changed_when: false

- name: Install or upgrade cert-manager via Helm (pinned if version set)
  command: >
    helm upgrade --install cert-manager {{ jetstack_helm_repo_name }}/cert-manager
    --namespace {{ cert_manager_namespace }}
    --create-namespace
    --set startupapicheck.enabled=false
    {{ '--version ' ~ cert_manager_chart_version if cert_manager_chart_version|length > 0 else '' }}
  register: certmgr_helm
  changed_when: >
    'STATUS: deployed' in certmgr_helm.stdout or
    'STATUS: upgraded' in certmgr_helm.stdout
  tags:
    - cert-manager

- name: Wait for cert-manager pods to be Ready
  command: kubectl -n {{ cert_manager_namespace }} get pods --no-headers
  register: certmgr_pods
  changed_when: false
  retries: 30
  delay: 6
  until:
    - certmgr_pods.rc == 0
    - certmgr_pods.stdout != ""
    - certmgr_pods.stdout is search("Running")
  tags:
    - cert-manager

- name: Wait for cert-manager webhook endpoints to be ready
  command: kubectl -n {{ cert_manager_namespace }} get endpoints cert-manager-webhook -o json
  register: certmgr_webhook_ep
  changed_when: false
  retries: 30
  delay: 6
  until:
    - certmgr_webhook_ep.rc == 0
    - certmgr_webhook_ep.stdout is search('"addresses"')
  tags:
    - cert-manager
